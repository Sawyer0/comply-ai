# Test configuration for detector orchestration service
# Used for performance and fault tolerance testing

# Service settings
service:
  host: "0.0.0.0"
  port: 8000
  workers: 4
  reload: false

# Detector configurations for testing
detectors:
  # Mock detector that always succeeds (for baseline testing)
  mock-success-detector:
    endpoint: "http://mock-detector:8001/detect"
    timeout_ms: 5000
    max_retries: 3
    auth:
      type: "none"
    supported_content_types: ["text", "document", "code"]
    capabilities:
      - "toxicity_detection"
      - "pii_detection"
      - "security_scan"

  # Mock detector with variable response times (for performance testing)
  mock-variable-detector:
    endpoint: "http://mock-detector:8002/detect"
    timeout_ms: 8000
    max_retries: 2
    auth:
      type: "none"
    supported_content_types: ["text", "code"]
    capabilities:
      - "code_analysis"
      - "vulnerability_scan"

  # Mock detector that fails intermittently (for fault tolerance testing)
  mock-failing-detector:
    endpoint: "http://mock-detector:8003/detect"
    timeout_ms: 3000
    max_retries: 1
    auth:
      type: "none"
    supported_content_types: ["text", "document"]
    capabilities:
      - "content_moderation"
      - "sentiment_analysis"

  # Mock detector that times out (for timeout testing)
  mock-timeout-detector:
    endpoint: "http://mock-detector:8004/detect"
    timeout_ms: 10000  # High timeout to test timeout handling
    max_retries: 2
    auth:
      type: "none"
    supported_content_types: ["document", "code"]
    capabilities:
      - "deep_analysis"
      - "pattern_recognition"

  # Mock detector for batch processing tests
  mock-batch-detector:
    endpoint: "http://mock-detector:8005/detect"
    timeout_ms: 6000
    max_retries: 3
    auth:
      type: "none"
    supported_content_types: ["text", "document", "code"]
    capabilities:
      - "batch_processing"
      - "bulk_analysis"

# Orchestration configuration
orchestration:
  # Cache settings
  cache_enabled: true
  cache_backend: "redis"  # Use redis for distributed testing
  redis_url: "redis://localhost:6379/0"
  redis_prefix: "test:orchestration"
  response_cache_ttl_seconds: 300  # 5 minutes

  # Circuit breaker settings for fault tolerance
  circuit_breaker_failure_threshold: 5
  circuit_breaker_recovery_timeout_seconds: 60

  # Health monitoring
  health_check_interval_seconds: 30
  unhealthy_threshold: 3

  # Request limits
  max_content_length: 50000  # 50KB
  default_timeout_ms: 5000

  # SLA settings
  sla:
    sync_request_sla_ms: 2000  # 2 second SLA
    sync_to_async_threshold_ms: 1500  # Convert to async if over 1.5s
    mapper_timeout_budget_ms: 1000  # 1 second for mapper calls

  # Coverage requirements
  secondary_on_coverage_below: true
  secondary_min_coverage: 0.8

  # Auto-mapping
  auto_map_results: true

  # Retry settings
  retry_on_timeouts: true
  retry_on_failures: true
  max_retries: 3

# Policy configuration
policies:
  base_path: "./test-policies"
  default_bundle: "test-policies"

# Rate limiting for testing
rate_limits:
  requests_per_minute: 1000  # High limit for load testing
  burst_limit: 100

# Metrics and monitoring
metrics:
  enabled: true
  prometheus_port: 9090

# Logging configuration
logging:
  level: "INFO"
  format: "json"
  include_trace: true

# Test-specific settings
test_settings:
  # Mock detector endpoints for testing
  mock_detectors:
    success_rate: 0.95  # 95% success rate for mock detectors
    variable_response_time: true  # Vary response times for realism
    failure_scenarios:
      - name: "random_failure"
        probability: 0.05  # 5% random failures
      - name: "timeout_scenario"
        probability: 0.02  # 2% timeouts
      - name: "slow_response"
        probability: 0.10  # 10% slow responses

  # Load testing profiles
  load_profiles:
    smoke:
      duration: "2m"
      vus: 5
      description: "Light load to verify basic functionality"

    normal_load:
      duration: "10m"
      vus: 50
      description: "Normal operational load"

    stress:
      duration: "5m"
      vus: 200
      description: "High load to test system limits"

    spike:
      duration: "3m"
      vus: 500
      description: "Spike test for sudden load increases"

  # Performance targets
  performance_targets:
    p95_response_time_ms: 2000  # <2s p95 requirement
    success_rate: 0.95  # 95% success rate
    throughput_rps: 100  # 100 requests per second minimum

  # Fault injection settings
  fault_injection:
    enabled: true
    failure_modes:
      - mode: "detector_down"
        probability: 0.01
        duration_seconds: 60
        description: "Simulate detector being unavailable"

      - mode: "network_latency"
        probability: 0.05
        latency_ms: 1000
        description: "Simulate network latency"

      - mode: "partial_outage"
        probability: 0.02
        affected_detectors: ["mock-failing-detector"]
        description: "Simulate partial service outage"
