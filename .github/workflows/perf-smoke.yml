name: Performance Smoke Tests

on:
  pull_request:
  workflow_dispatch:
    inputs:
      base_url:
        description: "Base URL of running service (e.g., https://staging.example.com)"
        required: false
        default: ""

jobs:
  perf-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      PYTHON_VERSION: "3.11"
      PERF_BASE_URL: ${{ github.event.inputs.base_url || vars.PERF_BASE_URL || secrets.PERF_BASE_URL || '' }}
      MAPPER_PERF_API_KEY: ${{ secrets.MAPPER_PERF_API_KEY || '' }}
      MAPPER_PERF_TENANT_ID: ${{ vars.MAPPER_PERF_TENANT_ID || 'perf-tenant' }}
      MAPPER_API_KEY_HEADER: ${{ vars.MAPPER_API_KEY_HEADER || 'X-API-Key' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Locust
        run: |
          python -m pip install --upgrade pip
          pip install locust

      - name: Set up k6
        uses: grafana/setup-k6-action@v1

      - name: Show configuration
        run: |
          echo "PERF_BASE_URL configured? ${{ env.PERF_BASE_URL != '' }}"
          echo "Tenant: ${{ env.MAPPER_PERF_TENANT_ID }}"

      - name: Run Locust smoke (conditionally)
        if: env.PERF_BASE_URL != ''
        run: |
          locust -f perf/locustfile.py --headless -u 5 -r 2 -t 30s --host "$PERF_BASE_URL"

      - name: Run k6 smoke (conditionally)
        if: env.PERF_BASE_URL != ''
        run: |
          k6 run perf/k6/smoke.js

      - name: Skip notice (no PERF_BASE_URL)
        if: env.PERF_BASE_URL == ''
        run: |
          echo "Skipping performance smoke tests because PERF_BASE_URL is not provided."
