name: orchestrator-conflict-tests

on:
  pull_request:
    paths:
      - 'detector-orchestration/**'
      - 'tests/unit/test_conflict_resolution_*'
      - 'tests/integration/test_aggregator_conflict_metadata.py'
  push:
    branches: [ main ]
    paths:
      - 'detector-orchestration/**'
      - 'tests/unit/test_conflict_resolution_*'
      - 'tests/integration/test_aggregator_conflict_metadata.py'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install test dependencies (minimal)
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio pytest-cov fastapi httpx pydantic hypothesis

      - name: Run conflict tests only (with coverage on conflict module)
        run: |
          python -m pytest \
            tests/unit/test_conflict_resolution_strategies.py \
            tests/unit/test_conflict_resolution_hypothesis.py \
            tests/unit/test_conflict_resolution_opa.py \
            tests/integration/test_aggregator_conflict_metadata.py \
            tests/integration/test_opa_override_strategy.py \
            --cov=detector_orchestration.conflict --cov-report=term-missing --cov-fail-under=90 -q
            tests/integration/test_opa_override_strategy.py -q
