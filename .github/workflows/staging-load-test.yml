name: Staging Load Tests

on:
  workflow_dispatch:
    inputs:
      base_url:
        description: "Base URL of staging service (e.g., https://staging.example.com)"
        required: true
      users:
        description: "Concurrent users (Locust -u)"
        required: false
        default: "50"
      spawn_rate:
        description: "Spawn rate users/sec (Locust -r)"
        required: false
        default: "5"
      duration:
        description: "Test duration (e.g., 10m)"
        required: false
        default: "10m"

jobs:
  load-test:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      PYTHON_VERSION: "3.11"
      PERF_BASE_URL: ${{ github.event.inputs.base_url }}
      LOCUST_USERS: ${{ github.event.inputs.users }}
      LOCUST_SPAWN: ${{ github.event.inputs.spawn_rate }}
      LOCUST_DURATION: ${{ github.event.inputs.duration }}
      MAPPER_PERF_API_KEY: ${{ secrets.MAPPER_PERF_API_KEY || '' }}
      MAPPER_PERF_TENANT_ID: ${{ vars.MAPPER_PERF_TENANT_ID || 'perf-tenant' }}
      MAPPER_API_KEY_HEADER: ${{ vars.MAPPER_API_KEY_HEADER || 'X-API-Key' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Locust
        run: |
          python -m pip install --upgrade pip
          pip install locust

      - name: Set up k6
        uses: grafana/setup-k6-action@v1

      - name: Run Locust load test
        run: |
          locust -f perf/locustfile.py --headless -u "$LOCUST_USERS" -r "$LOCUST_SPAWN" -t "$LOCUST_DURATION" --host "$PERF_BASE_URL" | tee locust.log

      - name: Run k6 load test
        run: |
          K6_VUS=${{ github.event.inputs.users }} K6_DURATION=${{ github.event.inputs.duration }} k6 run perf/k6/smoke.js | tee k6.log

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: staging-load-results
          path: |
            locust.log
            k6.log
