# Multi-stage Dockerfile for comprehensive testing framework
# Supports testing across Core Mapper, Detector Orchestration, and Analysis services

# Base stage with common dependencies
FROM python:3.11-slim as base

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    git \
    gcc \
    g++ \
    make \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Install Python dependencies for testing
COPY requirements-test.txt .
RUN pip install --no-cache-dir -r requirements-test.txt

# Testing stage
FROM base as test

# Copy source code and tests
COPY src/ ./src/
COPY tests/ ./tests/
COPY detector-orchestration/src/ ./detector-orchestration/src/
COPY detector-orchestration/tests/ ./detector-orchestration/tests/
COPY analysis/src/ ./analysis/src/
COPY analysis/tests/ ./analysis/tests/

# Copy configuration files
COPY pytest.ini .
COPY pyproject.toml .
COPY config/ ./config/

# Set environment variables for testing
ENV TESTING=true
ENV LOG_LEVEL=DEBUG
ENV PYTHONPATH=/app/src:/app/detector-orchestration/src:/app/analysis/src
ENV PYTEST_CURRENT_TEST=true

# Create directories for test artifacts
RUN mkdir -p /app/test-artifacts/coverage \
    /app/test-artifacts/reports \
    /app/test-artifacts/logs \
    /app/test-artifacts/performance

# Performance testing stage with additional tools
FROM test as performance

# Install performance testing tools
RUN pip install --no-cache-dir \
    locust \
    k6-python \
    pytest-benchmark \
    memory-profiler \
    py-spy

# Security testing stage with security tools
FROM test as security

# Install security testing tools
RUN pip install --no-cache-dir \
    bandit \
    safety \
    semgrep \
    pytest-security

# Install security scanners
RUN curl -sSfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

# Chaos testing stage with chaos engineering tools
FROM test as chaos

# Install chaos engineering tools
RUN pip install --no-cache-dir \
    chaostoolkit \
    chaostoolkit-kubernetes \
    chaostoolkit-prometheus

# Full testing stage with all tools
FROM base as full

# Install all testing dependencies
RUN pip install --no-cache-dir \
    # Core testing
    pytest \
    pytest-asyncio \
    pytest-cov \
    pytest-mock \
    pytest-timeout \
    pytest-xdist \
    pytest-html \
    pytest-benchmark \
    pytest-security \
    # Performance testing
    locust \
    memory-profiler \
    py-spy \
    # Security testing  
    bandit \
    safety \
    semgrep \
    # Chaos engineering
    chaostoolkit \
    # Database and service clients
    asyncpg \
    redis \
    clickhouse-driver \
    httpx \
    docker \
    # Data generation and analysis
    faker \
    hypothesis \
    pandas \
    numpy \
    # Monitoring and observability
    structlog \
    opentelemetry-api \
    opentelemetry-sdk \
    # Additional utilities
    pyyaml \
    requests \
    tenacity

# Copy all source code and tests
COPY . /app/

# Set comprehensive environment variables
ENV TESTING=true \
    LOG_LEVEL=DEBUG \
    PYTHONPATH=/app/src:/app/detector-orchestration/src:/app/analysis/src \
    PYTEST_CURRENT_TEST=true \
    COVERAGE_CORE=sysmon \
    PYTEST_TIMEOUT=300

# Create comprehensive test artifact directories
RUN mkdir -p \
    /app/test-artifacts/coverage/html \
    /app/test-artifacts/coverage/xml \
    /app/test-artifacts/reports/junit \
    /app/test-artifacts/reports/html \
    /app/test-artifacts/logs/pytest \
    /app/test-artifacts/logs/services \
    /app/test-artifacts/performance/locust \
    /app/test-artifacts/performance/benchmark \
    /app/test-artifacts/security/bandit \
    /app/test-artifacts/security/safety \
    /app/test-artifacts/chaos/reports \
    /app/test-artifacts/golden-datasets

# Create test execution scripts
RUN cat > /app/run-unit-tests.sh << 'EOF'
#!/bin/bash
set -e
echo "Running unit tests..."
pytest tests/unit/ \
    --verbose \
    --tb=short \
    --cov=src/llama_mapper \
    --cov=detector-orchestration/src \
    --cov=analysis/src \
    --cov-report=html:/app/test-artifacts/coverage/html \
    --cov-report=xml:/app/test-artifacts/coverage/coverage.xml \
    --junitxml=/app/test-artifacts/reports/junit/unit-tests.xml \
    --maxfail=10 \
    -m "unit and not slow"
EOF

RUN cat > /app/run-integration-tests.sh << 'EOF'
#!/bin/bash
set -e
echo "Running integration tests..."
pytest tests/integration/ \
    --verbose \
    --tb=short \
    --junitxml=/app/test-artifacts/reports/junit/integration-tests.xml \
    --maxfail=5 \
    -m "integration"
EOF

RUN cat > /app/run-cross-service-tests.sh << 'EOF'
#!/bin/bash
set -e
echo "Running cross-service tests..."
pytest tests/cross_service/ \
    --verbose \
    --tb=short \
    --junitxml=/app/test-artifacts/reports/junit/cross-service-tests.xml \
    --maxfail=3 \
    -m "cross_service or e2e"
EOF

RUN cat > /app/run-performance-tests.sh << 'EOF'
#!/bin/bash
set -e
echo "Running performance tests..."
pytest tests/performance/ \
    --verbose \
    --tb=short \
    --junitxml=/app/test-artifacts/reports/junit/performance-tests.xml \
    --benchmark-json=/app/test-artifacts/performance/benchmark/results.json \
    -m "performance"
EOF

RUN cat > /app/run-security-tests.sh << 'EOF'
#!/bin/bash
set -e
echo "Running security tests..."

# Bandit security linting
echo "Running Bandit security scan..."
bandit -r src/ detector-orchestration/src/ analysis/src/ \
    -f json -o /app/test-artifacts/security/bandit/results.json

# Safety dependency check
echo "Running Safety dependency check..."
safety check --json --output /app/test-artifacts/security/safety/results.json

# Security pytest tests
echo "Running security-focused tests..."
pytest tests/security/ \
    --verbose \
    --tb=short \
    --junitxml=/app/test-artifacts/reports/junit/security-tests.xml \
    -m "security"
EOF

RUN cat > /app/run-chaos-tests.sh << 'EOF'
#!/bin/bash
set -e
echo "Running chaos engineering tests..."
pytest tests/chaos/ \
    --verbose \
    --tb=short \
    --junitxml=/app/test-artifacts/reports/junit/chaos-tests.xml \
    -m "chaos"
EOF

RUN cat > /app/run-all-tests.sh << 'EOF'
#!/bin/bash
set -e
echo "Running comprehensive test suite..."

# Run tests in order
./run-unit-tests.sh
./run-integration-tests.sh
./run-cross-service-tests.sh
./run-performance-tests.sh
./run-security-tests.sh
./run-chaos-tests.sh

echo "All tests completed!"
echo "Results available in /app/test-artifacts/"
EOF

# Make scripts executable
RUN chmod +x /app/*.sh

# Health check for test runner
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python -c "import sys; sys.exit(0)"

# Default command runs the comprehensive test suite
CMD ["./run-all-tests.sh"]
