version: '3.8'

# Multi-service test environment for Llama Mapper
# This configuration provides isolated testing environment for:
# - Core Mapper Service
# - Detector Orchestration Service  
# - Analysis Service
# - Supporting infrastructure (PostgreSQL, Redis, ClickHouse)

services:
  # Infrastructure Services
  postgres-test:
    image: postgres:15
    container_name: llama-mapper-postgres-test
    environment:
      POSTGRES_DB: llama_mapper_test
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_password
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
    ports:
      - "5433:5432"  # Different port to avoid conflicts
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
      - ./init-scripts/postgres:/docker-entrypoint-initdb.d
    networks:
      - test-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test_user -d llama_mapper_test"]
      interval: 10s
      timeout: 5s
      retries: 5
    command: >
      postgres -c log_statement=all
               -c log_destination=stderr
               -c logging_collector=off
               -c max_connections=200

  redis-test:
    image: redis:7-alpine
    container_name: llama-mapper-redis-test
    ports:
      - "6380:6379"  # Different port to avoid conflicts
    volumes:
      - redis_test_data:/data
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    command: >
      redis-server --save 60 1000
                   --loglevel notice
                   --maxmemory 512mb
                   --maxmemory-policy allkeys-lru

  clickhouse-test:
    image: yandex/clickhouse-server:latest
    container_name: llama-mapper-clickhouse-test
    environment:
      CLICKHOUSE_DB: llama_mapper_analytics_test
      CLICKHOUSE_USER: test_user
      CLICKHOUSE_PASSWORD: test_password
    ports:
      - "9001:9000"  # Different port to avoid conflicts
      - "8124:8123"  # HTTP interface
    volumes:
      - clickhouse_test_data:/var/lib/clickhouse
      - ./init-scripts/clickhouse:/docker-entrypoint-initdb.d
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "clickhouse-client", "--query=SELECT 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    ulimits:
      nofile:
        soft: 262144
        hard: 262144

  # Core Application Services
  core-mapper-test:
    build:
      context: ..
      dockerfile: Dockerfile
      target: test
    container_name: llama-mapper-core-test
    environment:
      # Database configuration
      LLAMA_MAPPER_DATABASE__HOST: postgres-test
      LLAMA_MAPPER_DATABASE__PORT: 5432
      LLAMA_MAPPER_DATABASE__NAME: llama_mapper_test
      LLAMA_MAPPER_DATABASE__USER: test_user
      LLAMA_MAPPER_DATABASE__PASSWORD: test_password
      
      # Redis configuration
      LLAMA_MAPPER_REDIS__HOST: redis-test
      LLAMA_MAPPER_REDIS__PORT: 6379
      LLAMA_MAPPER_REDIS__DB: 0
      
      # Test configuration
      TESTING: "true"
      LOG_LEVEL: DEBUG
      PRIVACY_MODE: "true"
      
      # Model configuration for testing
      LLAMA_MAPPER_MODEL__SERVING_BACKEND: mock
      LLAMA_MAPPER_MODEL__TEMPERATURE: 0.1
      
      # Security configuration
      LLAMA_MAPPER_SECURITY__ENABLE_FIELD_ENCRYPTION: "false"
      LLAMA_MAPPER_SECURITY__RATE_LIMITING_ENABLED: "false"
    ports:
      - "8001:8000"  # Different port to avoid conflicts
    volumes:
      - ../src:/app/src
      - ../tests:/app/tests
      - ../config:/app/config
    networks:
      - test-network
    depends_on:
      postgres-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    command: >
      sh -c "
        # Wait for dependencies
        sleep 10 &&
        # Run database migrations
        python -m llama_mapper.cli migrate --config config.yaml &&
        # Start the service
        uvicorn src.llama_mapper.api.main:app 
          --host 0.0.0.0 
          --port 8000 
          --reload
          --log-level debug
      "

  detector-orchestration-test:
    build:
      context: ../detector-orchestration
      dockerfile: Dockerfile
      target: test
    container_name: llama-mapper-orchestration-test
    environment:
      # Database configuration
      ORCH_DATABASE__HOST: postgres-test
      ORCH_DATABASE__PORT: 5432
      ORCH_DATABASE__NAME: llama_mapper_test
      ORCH_DATABASE__USER: test_user
      ORCH_DATABASE__PASSWORD: test_password
      
      # Redis configuration
      ORCH_REDIS__HOST: redis-test
      ORCH_REDIS__PORT: 6379
      ORCH_REDIS__DB: 1
      
      # Service dependencies
      ORCH_MAPPER_SERVICE_URL: http://core-mapper-test:8000
      
      # Test configuration
      TESTING: "true"
      LOG_LEVEL: DEBUG
      
      # Detector configuration for testing
      ORCH_DETECTOR_TIMEOUT: 30
      ORCH_CIRCUIT_BREAKER_ENABLED: "true"
      ORCH_AUTO_MAP_RESULTS: "false"
    ports:
      - "8002:8000"  # Different port to avoid conflicts
    volumes:
      - ../detector-orchestration/src:/app/src
      - ../detector-orchestration/tests:/app/tests
    networks:
      - test-network
    depends_on:
      postgres-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
      core-mapper-test:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    command: >
      sh -c "
        # Wait for dependencies
        sleep 15 &&
        # Start the service
        uvicorn src.detector_orchestration.api.main:app 
          --host 0.0.0.0 
          --port 8000 
          --reload
          --log-level debug
      "

  analysis-service-test:
    build:
      context: ../analysis
      dockerfile: Dockerfile
      target: test
    container_name: llama-mapper-analysis-test
    environment:
      # PostgreSQL configuration
      ANALYSIS_POSTGRES_HOST: postgres-test
      ANALYSIS_POSTGRES_PORT: 5432
      ANALYSIS_POSTGRES_DB: llama_mapper_test
      ANALYSIS_POSTGRES_USER: test_user
      ANALYSIS_POSTGRES_PASSWORD: test_password
      
      # ClickHouse configuration
      ANALYSIS_CLICKHOUSE_HOST: clickhouse-test
      ANALYSIS_CLICKHOUSE_PORT: 9000
      ANALYSIS_CLICKHOUSE_DB: llama_mapper_analytics_test
      ANALYSIS_CLICKHOUSE_USER: test_user
      ANALYSIS_CLICKHOUSE_PASSWORD: test_password
      
      # Test configuration
      TESTING: "true"
      LOG_LEVEL: DEBUG
      
      # Analysis configuration
      ANALYSIS_BATCH_SIZE: 100
      ANALYSIS_PROCESSING_TIMEOUT: 60
    ports:
      - "8003:8000"  # Different port to avoid conflicts
    volumes:
      - ../analysis/src:/app/src
      - ../analysis/tests:/app/tests
    networks:
      - test-network
    depends_on:
      postgres-test:
        condition: service_healthy
      clickhouse-test:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    command: >
      sh -c "
        # Wait for dependencies
        sleep 20 &&
        # Initialize ClickHouse tables
        python -m analysis.cli init-clickhouse &&
        # Start the service
        uvicorn src.analysis.api.main:app 
          --host 0.0.0.0 
          --port 8000 
          --reload
          --log-level debug
      "

  # Test Utilities and Tools
  test-runner:
    build:
      context: ..
      dockerfile: tests/Dockerfile.test
    container_name: llama-mapper-test-runner
    environment:
      # Test configuration
      TESTING: "true"
      LOG_LEVEL: DEBUG
      PYTEST_CURRENT_TEST: "true"
      
      # Service URLs for integration tests
      CORE_MAPPER_URL: http://core-mapper-test:8000
      DETECTOR_ORCHESTRATION_URL: http://detector-orchestration-test:8000
      ANALYSIS_SERVICE_URL: http://analysis-service-test:8000
      
      # Database URLs for test access
      POSTGRES_URL: postgresql://test_user:test_password@postgres-test:5432/llama_mapper_test
      REDIS_URL: redis://redis-test:6379/0
      CLICKHOUSE_URL: http://test_user:test_password@clickhouse-test:8123/llama_mapper_analytics_test
    volumes:
      - ../src:/app/src
      - ../tests:/app/tests
      - ../detector-orchestration/src:/app/detector-orchestration/src
      - ../detector-orchestration/tests:/app/detector-orchestration/tests
      - ../analysis/src:/app/analysis/src
      - ../analysis/tests:/app/analysis/tests
      - test_artifacts:/app/test-artifacts
    networks:
      - test-network
    depends_on:
      core-mapper-test:
        condition: service_healthy
      detector-orchestration-test:
        condition: service_healthy
      analysis-service-test:
        condition: service_healthy
    command: >
      sh -c "
        # Wait for all services to be ready
        sleep 30 &&
        # Run test suite
        pytest tests/ 
          --verbose 
          --tb=short 
          --maxfail=5 
          --cov=src 
          --cov-report=html:/app/test-artifacts/coverage
          --junitxml=/app/test-artifacts/junit.xml
      "
    profiles:
      - test-execution

  # Mock External Services for Testing
  mock-detector-presidio:
    image: nginx:alpine
    container_name: mock-detector-presidio
    volumes:
      - ./mock-services/presidio:/usr/share/nginx/html
    ports:
      - "8010:80"
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  mock-detector-deberta:
    image: nginx:alpine
    container_name: mock-detector-deberta
    volumes:
      - ./mock-services/deberta:/usr/share/nginx/html
    ports:
      - "8011:80"
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 10s
      timeout: 5s
      retries: 3

# Shared volumes for test data persistence
volumes:
  postgres_test_data:
    driver: local
  redis_test_data:
    driver: local
  clickhouse_test_data:
    driver: local
  test_artifacts:
    driver: local

# Test network for service communication
networks:
  test-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
