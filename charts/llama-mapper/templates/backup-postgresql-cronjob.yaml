apiVersion: batch/v1
kind: CronJob
metadata:
  name: backup-postgresql
  namespace: {{ .Values.namespace | default "default" }}
  labels:
    app: backup-postgresql
    component: backup
spec:
  schedule: {{ .Values.backups.postgresql.schedule | quote }}
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: backup-postgresql
            component: backup
        spec:
          restartPolicy: OnFailure
          containers:
          - name: backup-postgresql
            image: {{ .Values.backups.postgresql.image | quote }}
            command:
            - /bin/bash
            - -c
            - |
              set -e
              echo "Starting PostgreSQL backup..."
              
              # Install required packages
              apt-get update && apt-get install -y \
                postgresql-client \
                python3 \
                python3-pip \
                curl \
                && rm -rf /var/lib/apt/lists/*
              
              # Install Python dependencies
              pip3 install boto3 psycopg2-binary
              
              # Create backup configuration
              cat > /tmp/backup-config.json << EOF
              {
                "s3": {
                  "bucket": "{{ .Values.backups.s3.bucket }}",
                  "region": "{{ .Values.backups.s3.region }}",
                  "endpoint_url": {{ if .Values.backups.s3.endpointUrl }}"{{ .Values.backups.s3.endpointUrl }}"{{ else }}null{{ end }}
                },
                "postgresql": {
                  "host": "{{ .Values.backups.postgresql.host }}",
                  "port": {{ .Values.backups.postgresql.port }},
                  "database": "{{ .Values.backups.postgresql.database }}",
                  "user": "{{ .Values.backups.postgresql.user }}",
                  "password": "$POSTGRES_PASSWORD"
                },
                "retention": {
                  "days": {{ .Values.backups.retention.days }},
                  "compliance_days": {{ .Values.backups.retention.complianceDays }}
                }
              }
              EOF
              
              # Set AWS credentials for S3
              export AWS_ACCESS_KEY_ID="$AWS_ACCESS_KEY_ID"
              export AWS_SECRET_ACCESS_KEY="$AWS_SECRET_ACCESS_KEY"
              {{- if .Values.backups.s3.endpointUrl }}
              export AWS_DEFAULT_REGION="{{ .Values.backups.s3.region }}"
              {{- end }}
              
              # Run backup
              python3 /scripts/backup-databases.py \
                --config /tmp/backup-config.json \
                --database postgresql
              
              echo "PostgreSQL backup completed successfully"
            env:
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.backups.postgresql.secretName }}
                  key: password
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.backups.s3.secretName }}
                  key: access_key_id
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.backups.s3.secretName }}
                  key: secret_access_key
            volumeMounts:
            - name: backup-scripts
              mountPath: /scripts
            resources:
              {{- toYaml .Values.backups.postgresql.resources | nindent 14 }}
          volumes:
          - name: backup-scripts
            configMap:
              name: backup-scripts
              defaultMode: 0755
          {{- with .Values.backups.postgresql.nodeSelector }}
          nodeSelector:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.backups.postgresql.affinity }}
          affinity:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.backups.postgresql.tolerations }}
          tolerations:
            {{- toYaml . | nindent 12 }}
          {{- end }}
