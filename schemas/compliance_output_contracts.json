{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "ComplianceOutputContracts",
  "description": "Comprehensive JSON schemas for all compliance analyst tasks with mandatory grounding",
  "type": "object",
  "definitions": {
    "citation": {
      "type": "object",
      "required": ["chunk_text", "citation", "pub_date", "source_id"],
      "properties": {
        "chunk_text": {
          "type": "string",
          "description": "Exact text chunk from retrieved document",
          "minLength": 10,
          "maxLength": 2000
        },
        "citation": {
          "type": "string", 
          "description": "Proper regulatory citation (e.g., 'GDPR Art. 35', '21 CFR 11.10')",
          "pattern": "^[A-Z0-9\\s]+\\s+(Art\\.|ยง|Section|Rule)\\s+[0-9]+.*$"
        },
        "pub_date": {
          "type": "string",
          "format": "date",
          "description": "Publication or effective date (YYYY-MM-DD)"
        },
        "source_id": {
          "type": "string",
          "description": "Unique identifier for source document"
        },
        "section_granularity": {
          "type": "string",
          "description": "Specific section/subsection/paragraph reference"
        },
        "authority": {
          "type": "string",
          "description": "Regulatory authority or issuing body"
        }
      }
    },
    "jurisdiction": {
      "type": "object",
      "required": ["code", "name", "effective_date"],
      "properties": {
        "code": {
          "type": "string",
          "enum": ["EU", "US", "UK", "CA", "AU", "GLOBAL"],
          "description": "Jurisdiction code"
        },
        "name": {
          "type": "string",
          "description": "Full jurisdiction name"
        },
        "effective_date": {
          "type": "string",
          "format": "date",
          "description": "Date when regulation became effective"
        },
        "superseded_date": {
          "type": "string",
          "format": "date",
          "description": "Date when regulation was superseded (if applicable)"
        }
      }
    },
    "next_action": {
      "type": "object",
      "required": ["action", "owner", "due_date", "priority"],
      "properties": {
        "action": {
          "type": "string",
          "minLength": 10,
          "maxLength": 200,
          "description": "Specific action to be taken"
        },
        "owner": {
          "type": "string",
          "description": "Responsible party or role"
        },
        "due_date": {
          "type": "string",
          "format": "date",
          "description": "Target completion date"
        },
        "priority": {
          "type": "string",
          "enum": ["critical", "high", "medium", "low"],
          "description": "Action priority level"
        },
        "estimated_effort": {
          "type": "string",
          "description": "Estimated effort (e.g., '2 weeks', '1 day')"
        },
        "dependencies": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Other actions this depends on"
        }
      }
    },
    "risk_rationale": {
      "type": "object",
      "required": ["level", "justification", "evidence_based"],
      "properties": {
        "level": {
          "type": "string",
          "enum": ["critical", "high", "medium", "low", "negligible"],
          "description": "Risk level assessment"
        },
        "justification": {
          "type": "string",
          "minLength": 20,
          "maxLength": 500,
          "description": "Detailed justification for risk level"
        },
        "evidence_based": {
          "type": "boolean",
          "description": "Whether assessment is based on concrete evidence"
        },
        "confidence": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Confidence in risk assessment"
        },
        "factors": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Key factors contributing to risk level"
        },
        "mitigation_urgency": {
          "type": "string",
          "enum": ["immediate", "within_week", "within_month", "quarterly"],
          "description": "Urgency for mitigation action"
        }
      }
    },
    "base_compliance_output": {
      "type": "object",
      "required": ["analysis_type", "jurisdictions", "effective_dates", "citations", "risk_rationale", "next_actions", "confidence", "grounding_validated"],
      "properties": {
        "analysis_type": {
          "type": "string",
          "description": "Type of compliance analysis performed"
        },
        "jurisdictions": {
          "type": "array",
          "items": {"$ref": "#/definitions/jurisdiction"},
          "minItems": 1,
          "description": "Applicable jurisdictions with effective dates"
        },
        "effective_dates": {
          "type": "array",
          "items": {
            "type": "string",
            "format": "date"
          },
          "minItems": 1,
          "description": "Key effective dates for regulations"
        },
        "citations": {
          "type": "array",
          "items": {"$ref": "#/definitions/citation"},
          "minItems": 1,
          "description": "Regulatory citations with grounding"
        },
        "risk_rationale": {
          "$ref": "#/definitions/risk_rationale",
          "description": "Detailed risk assessment with justification"
        },
        "next_actions": {
          "type": "array",
          "items": {"$ref": "#/definitions/next_action"},
          "minItems": 1,
          "description": "Specific next actions with owners and due dates"
        },
        "confidence": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Overall confidence in analysis"
        },
        "grounding_validated": {
          "type": "boolean",
          "description": "Whether all citations have been validated against retrieved chunks"
        },
        "uncertainty_notice": {
          "type": "string",
          "description": "Notice about uncertainties or limitations in analysis"
        },
        "evidence_gaps": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Areas where additional evidence is needed"
        },
        "conservative_approach_applied": {
          "type": "boolean",
          "description": "Whether conservative risk posture was applied due to uncertainty"
        },
        "temporal_validation": {
          "type": "object",
          "properties": {
            "all_sources_current": {"type": "boolean"},
            "stale_sources_flagged": {"type": "array", "items": {"type": "string"}},
            "update_threshold_days": {"type": "integer"}
          }
        }
      }
    }
  },
  "oneOf": [
    {
      "title": "GapAnalysis",
      "allOf": [
        {"$ref": "#/definitions/base_compliance_output"},
        {
          "properties": {
            "analysis_type": {"const": "gap_analysis"},
            "gaps_identified": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["gap_description", "regulatory_requirement", "current_state", "target_state"],
                "properties": {
                  "gap_description": {"type": "string", "minLength": 20, "maxLength": 300},
                  "regulatory_requirement": {"type": "string"},
                  "current_state": {"type": "string"},
                  "target_state": {"type": "string"},
                  "gap_severity": {"type": "string", "enum": ["critical", "high", "medium", "low"]},
                  "compliance_deadline": {"type": "string", "format": "date"}
                }
              },
              "minItems": 1
            },
            "compliance_percentage": {
              "type": "number",
              "minimum": 0.0,
              "maximum": 100.0,
              "description": "Overall compliance percentage"
            },
            "frameworks_assessed": {
              "type": "array",
              "items": {"type": "string"},
              "description": "Regulatory frameworks assessed"
            }
          },
          "required": ["gaps_identified", "compliance_percentage", "frameworks_assessed"]
        }
      ]
    },
    {
      "title": "RiskRating",
      "allOf": [
        {"$ref": "#/definitions/base_compliance_output"},
        {
          "properties": {
            "analysis_type": {"const": "risk_rating"},
            "risk_scores": {
              "type": "object",
              "required": ["overall_score", "category_scores"],
              "properties": {
                "overall_score": {
                  "type": "number",
                  "minimum": 0.0,
                  "maximum": 10.0,
                  "description": "Overall risk score (0-10 scale)"
                },
                "category_scores": {
                  "type": "object",
                  "properties": {
                    "privacy": {"type": "number", "minimum": 0.0, "maximum": 10.0},
                    "security": {"type": "number", "minimum": 0.0, "maximum": 10.0},
                    "operational": {"type": "number", "minimum": 0.0, "maximum": 10.0},
                    "financial": {"type": "number", "minimum": 0.0, "maximum": 10.0},
                    "reputational": {"type": "number", "minimum": 0.0, "maximum": 10.0}
                  }
                }
              }
            },
            "risk_factors": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["factor", "impact", "likelihood"],
                "properties": {
                  "factor": {"type": "string"},
                  "impact": {"type": "string", "enum": ["critical", "high", "medium", "low"]},
                  "likelihood": {"type": "string", "enum": ["very_high", "high", "medium", "low", "very_low"]}
                }
              }
            },
            "risk_appetite_alignment": {
              "type": "string",
              "enum": ["within_appetite", "approaching_limit", "exceeds_appetite"],
              "description": "Alignment with organizational risk appetite"
            }
          },
          "required": ["risk_scores", "risk_factors", "risk_appetite_alignment"]
        }
      ]
    },
    {
      "title": "RemediationPlan",
      "allOf": [
        {"$ref": "#/definitions/base_compliance_output"},
        {
          "properties": {
            "analysis_type": {"const": "remediation_plan"},
            "remediation_steps": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["step_number", "description", "owner", "target_date", "success_criteria"],
                "properties": {
                  "step_number": {"type": "integer", "minimum": 1},
                  "description": {"type": "string", "minLength": 20, "maxLength": 500},
                  "owner": {"type": "string"},
                  "target_date": {"type": "string", "format": "date"},
                  "success_criteria": {"type": "string"},
                  "dependencies": {"type": "array", "items": {"type": "string"}},
                  "resources_required": {"type": "array", "items": {"type": "string"}},
                  "estimated_cost": {"type": "string"},
                  "risk_if_delayed": {"type": "string"}
                }
              },
              "minItems": 1
            },
            "implementation_timeline": {
              "type": "object",
              "required": ["start_date", "target_completion", "milestones"],
              "properties": {
                "start_date": {"type": "string", "format": "date"},
                "target_completion": {"type": "string", "format": "date"},
                "milestones": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "required": ["milestone", "date"],
                    "properties": {
                      "milestone": {"type": "string"},
                      "date": {"type": "string", "format": "date"}
                    }
                  }
                }
              }
            },
            "success_metrics": {
              "type": "array",
              "items": {"type": "string"},
              "description": "Measurable success criteria"
            }
          },
          "required": ["remediation_steps", "implementation_timeline", "success_metrics"]
        }
      ]
    },
    {
      "title": "EvidenceRequest",
      "allOf": [
        {"$ref": "#/definitions/base_compliance_output"},
        {
          "properties": {
            "analysis_type": {"const": "evidence_request"},
            "evidence_items": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["evidence_type", "description", "regulatory_basis", "urgency"],
                "properties": {
                  "evidence_type": {
                    "type": "string",
                    "enum": ["policy_document", "procedure", "audit_log", "training_record", "assessment_report", "certification", "contract", "other"]
                  },
                  "description": {"type": "string", "minLength": 20, "maxLength": 300},
                  "regulatory_basis": {"type": "string"},
                  "urgency": {"type": "string", "enum": ["immediate", "high", "medium", "low"]},
                  "specific_requirements": {"type": "array", "items": {"type": "string"}},
                  "acceptable_formats": {"type": "array", "items": {"type": "string"}},
                  "retention_period": {"type": "string"},
                  "responsible_party": {"type": "string"}
                }
              },
              "minItems": 1
            },
            "evidence_gap_impact": {
              "type": "string",
              "description": "Impact of missing evidence on compliance posture"
            },
            "collection_deadline": {
              "type": "string",
              "format": "date",
              "description": "Deadline for evidence collection"
            }
          },
          "required": ["evidence_items", "evidence_gap_impact", "collection_deadline"]
        }
      ]
    },
    {
      "title": "PolicyDiff",
      "allOf": [
        {"$ref": "#/definitions/base_compliance_output"},
        {
          "properties": {
            "analysis_type": {"const": "policy_diff"},
            "opa_policy_changes": {
              "type": "object",
              "required": ["before", "after", "rationale"],
              "properties": {
                "before": {"type": "string", "description": "Current OPA/Rego policy"},
                "after": {"type": "string", "description": "Proposed OPA/Rego policy"},
                "rationale": {"type": "string", "minLength": 50, "maxLength": 1000},
                "impact_assessment": {"type": "string"},
                "rollback_plan": {"type": "string"},
                "testing_requirements": {"type": "array", "items": {"type": "string"}}
              }
            },
            "policy_changes": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["section", "change_type", "current_text", "proposed_text"],
                "properties": {
                  "section": {"type": "string"},
                  "change_type": {"type": "string", "enum": ["add", "modify", "remove", "relocate"]},
                  "current_text": {"type": "string"},
                  "proposed_text": {"type": "string"},
                  "regulatory_driver": {"type": "string"},
                  "business_impact": {"type": "string"}
                }
              }
            },
            "implementation_guidance": {
              "type": "object",
              "required": ["deployment_steps", "validation_criteria"],
              "properties": {
                "deployment_steps": {"type": "array", "items": {"type": "string"}},
                "validation_criteria": {"type": "array", "items": {"type": "string"}},
                "monitoring_requirements": {"type": "array", "items": {"type": "string"}}
              }
            }
          },
          "required": ["opa_policy_changes", "policy_changes", "implementation_guidance"]
        }
      ]
    }
  ]
}
